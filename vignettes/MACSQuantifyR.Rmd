---
title: "MACSQuantifyR"
author: "Peyronlab @ C3M-U1065 INSERM"
date: "`r Sys.Date()`"
output:
    prettydoc::html_pretty:
        theme: cayman
        highlight: vignette
        toc: true
        css: MACSQuantifyR.css
vignette: >
    %\VignetteIndexEntry{MACSQuantifyR}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    fig.width = 8,
    fig.height = 8
)
```

# Introduction 

MACSQuantify miltenyi analyzer can be used to profile many biological features. 

In order to avoid experimental errors and money waste, biologists are often
prompt to choose their own experimental design to prepare their wells before
using this device. This can lead to unique and complex types of plate templates
across biologists (e.g multiples drugs on one plate). 
Also a lack of an effective way for the biologist to handle his data 
automatically can arise from these difficulties. 

To illustrate the benefits of this package throughout this introduction, we take
the example of a drug screening experiment on cell viability. More precisely
, this experiment corresponds to the screening of the combination effects of two
drugs on human cells. 


Here is the plate template chosen by the user that represents drugs alone 
(up part of the well plate) and combinations (low part of the well plate).

```{r, echo = FALSE}
library(grid)
library(png)
path_img1 <- system.file("extdata", "combo.png", package = "MACSQuantifyR")
img1 <- readPNG(path_img1)
grid.raster(img1)
```

From this experiment, the user can choose to export the results in the form of 
an excel spreadsheet. This document provides access to each replicates values
that needs to be treated. As mentioned previously each biologist has his own
preference, therefore most of the users are subject to a considerable waste of
time in the process of sorting the excel document according to the 
plate template they followed.  

One possible way to gain time would be to follow the template shown bellow 
(that would allow an automatic sorting of the replicates on the excel document);
in the meantime forcing biologists to follow one of those template could 
increase the complexity of the experiment and therefore increase the risk of
experimental errors.

```{r, echo = FALSE, fig.width=4, fig.height=4}
library(grid)
library(png)
library(gridExtra)

path_img3 <- system.file("extdata", "scheme1.png", package = "MACSQuantifyR")
path_img2 <- system.file("extdata", "scheme2.png", package = "MACSQuantifyR")

img3 <-  rasterGrob(as.raster(readPNG(path_img3)), interpolate = FALSE)
img2 <-  rasterGrob(as.raster(readPNG(path_img2)), interpolate = FALSE)

grid.arrange(img3, img2, ncol = 2)
paste("Horizontal template would allow to sort",
      "the excel document according to well names (A1, A2, A3...)"
      ,sep=" ")
paste("Vertical template would allow to sort",
      "the excel document according to full_path (well number)"
      ,sep=" ")
```

# Requirements


* Four columns MACSQuantify miltenyi excel output file 
with P1 and P1//P2 gates only

* Up to date version of R is recommended


# Pipeline

## load_MACSQuant() function import of your data

Load the packages 
```{r load}
library(MACSQuantifyR)
library(knitr)
library(grid)
library(png)
suppressMessages(library(R.utils))
```

Once the excel file is generated by miltenyi 
MACSQuantify software. You can load the data with the 
following function or by your own means.

It will generate a variable called my_data, 
necessary for the next steps of the analysis.

```{r load_file, include = TRUE}

filepath <- system.file("extdata", "drugs.xlsx", 
                        package = "MACSQuantifyR")
MACSQuant=load_MACSQuant(filepath)
# You can visualize the data loaded in R by calling my_data
my_data=slot(MACSQuant, "my_data")
kable(head(my_data), digits = 4)
```





## on_plate_selection() function does all the analysis 

### Step 1: Manual user selection of replicates and conditions

Calling the function on_plate_selection() with the number 
of conditions in the experiment and the number of replicates
by conditions, the user will be asked to select sequentially 
the replicates for each conditions. Before running the function, 
the user can create a variable called c_names in which condition 
names are stored.

For example:
```{r eval=FALSE}
# this line is used to created c_names variable 
# (arbitrary condition names) for this experiment
slot(MACSQuant,"param.experiment")$c_names <- c(sprintf("Drug1_c%d", 1:8))
MACSQuant=on_plate_selection(MACSQuant, 
                   number_of_replicates = 3, 
                   number_of_conditions = 8)
```

This line will generate a plot on which the user 
can select the replicates.

```{r, echo = FALSE}

example_path <- system.file("extdata/", 
                            "plate_template.png", 
                            package = "MACSQuantifyR")
example_image <- readPNG(example_path)
grid.raster(example_image)
```
```{r echo = FALSE}
R.utils::printf(paste("...To quit press ESC...\n",
    "...You can now select your conditions",
    "replicates (without control condition replicates)...\n",
    "--> 18 conditions:...1...2...3...4...5...6...7...8...9",
   "...10...11...12...13...14...15...16...17...18...OK\n",
    "--> Done: replicates identified",sep=" "))
```




In this example, the user is screening the effect of two drugs on human cells
at different concentration. Each condition contains 3 replicates 
(i.e: Drug1_c1 is the concentration for drug1 at concentration c1 and 
the replicates are B2, C2 ,D2)

### Step 2: Automatic sorting of the data

Once the replicates of all conditions have been identified by the user, 
the on_plate_selection function will automatically reorder the data stored 
in the variable my_data into a new variable called my_data_sorted. 

See [export](#export) to save variable my_data_sorted.

The user may encounter warnings such as 

```{r echo = FALSE}
warning(paste("In order_data(sorted_matrix_final, my_data, save.files =",
              "save.files) : \n !!! A2 not selected and will be ignored",
               sep=" "))
```

In this case this means that there were some conditions that were 
not selected. Here A2 stands for the calibration well and should not 
be used in this analysis. 

If no error are encountered you should see the following:

```{r echo = FALSE}
cat("--> Done: replicates stored in variable my_replicates_sorted
    --> Done: Replicates sorted")
```

### Step 3: Automatic statistical treatment of the data

The final step of this function is the basic statistical analysis 
for each condition (mean and standard deviation of replicates).
This will generate a new variable called statistics necessary for the 
next part of the pipeline. 



```{r}
drugs_R_image <- system.file("extdata", 
                                   "drugs.Rdata", 
                                   package = "MACSQuantifyR")
load(drugs_R_image)
kable(slot(MACSQuant, "statistics"), digits = 4)
```

In this table the user will find for each conditions:

* the name (full path) and the WID of the first replicate
* the mean of percentage over replicates of cells that incorporated the 
fluorochrome: Fluo.percent.plus and Fluo.percent.minus 
(here mortality experiment with DAPI gates)
* the standard variation for the aforementioned percentages over replicates
* the mean of cell counts over replicates 
* the standard deviation of cell count over replicates

### Step 4: Graphical representations 

At this step, the function starts to create graphical representations.

### Export results <a id="export"></a>

#### Intermediate data can be saved 

To do so use the argument save.files=T 

> on_plate_selection(MACSQuant,3,18, <span style="color:red">save.files=T</span>)

This will create a folder called outputMQ in your current 
directory and save: 

* The well plate template image (plate_template.png)
* The sorted_replicates data table (sorted_table.txt)
* The statistic table (statistics.txt) 

Be careful to avoid overriding data, content of 
existing outputMQ folder could be erased. 

#### Report generation

At the end of the analysis the function provides the user with two plots. 

```{r, echo = FALSE, fig.width=20, fig.height=20}
example_res1 <- system.file("extdata/", 
                            "barplot_counts.png", 
                            package = "MACSQuantifyR")
example_res2 <- system.file("extdata/", 
                            "barplot_percent.png", 
                            package = "MACSQuantifyR")
img4 <-  rasterGrob(as.raster(readPNG(example_res1)), interpolate = FALSE)
img5 <-  rasterGrob(as.raster(readPNG(example_res2)), interpolate = FALSE)
grid.arrange(img4, img5, ncol = 2)

```

## Combination index calculation

At the end of the analysis... 
